# 🐞 Bug 修复日志 (Bug Fix Log)

本文档旨在追踪并记录 TaskCube 项目中已识别并修复的关键 Bug，以便于版本追溯和问题复盘。

---

## v3.1.1

*   **核心目标**: 修复用户反馈的核心交互 Bug，提升应用的稳定性。

### ✅ 已修复: 表格视图筛选按钮重复点击导致白屏崩溃

*   **故障现象 (Symptom)**: 
    在“列表视图”中，当用户点击一个列标题旁的筛选按钮打开筛选浮窗后，如果再次点击同一个筛选按钮（意图关闭浮窗），整个应用会崩溃并显示白屏。

*   **根本原因 (Root Cause)**:
    这是一个由 **`mousedown` 和 `click` 事件竞争** 导致的渲染冲突。当再次点击筛选按钮时：
    1.  首先，`mousedown` 事件触发了全局的“点击外部关闭”监听器，该监听器立即执行了关闭浮窗的逻辑。
    2.  紧接着，`click` 事件（在 `mouseup` 之后触发）又执行了按钮自身的点击处理逻辑，该逻辑再次尝试关闭同一个（可能即将被卸载的）浮窗。
    这种在极短时间内对同一个组件进行两次关闭操作的行为，导致了 React 渲染周期的崩溃。

*   **解决方案 (Resolution)**:
    在 `TableView.tsx` 中，为筛选按钮添加了 `onMouseDown={e => e.stopPropagation()}` 事件处理器。这会阻止 `mousedown` 事件从按钮“冒泡”到顶层的 `document`，从而禁用了全局的“点击外部关闭”监听器。这样，只有按钮自身的 `click` 事件能够触发关闭逻辑，确保了关闭操作只被执行一次，彻底消除了事件竞争，解决了该崩溃问题。

---

## v2.10.1

*   **核心目标**: 修复用户反馈的三个核心体验问题，提升应用的稳定性和可用性。

### ✅ 已修复: 新建任务时 AI 分析状态未重置

*   **故障现象 (Symptom)**: 
    在“新建任务”模态框中，如果用户点击了“AI 智能识别”按钮，但在分析完成前就关闭了模态框，那么下次再打开“新建任务”时，输入框会卡在“AI 分析中...”的只读状态。

*   **根本原因 (Root Cause)**:
    `TaskDetailModal` 组件的 `isSmartFilling` 状态没有在每次模态框打开时被显式重置。如果一个异步的 AI 分析操作在模态框关闭后才完成，它无法更新一个已经卸载的组件的状态。但问题在于，该状态的初始值 `false` 依赖于组件的重新挂载，而在某些情况下（如快速操作），状态可能会出现意外的残留。

*   **解决方案 (Resolution)**:
    在 `TaskDetailModal.tsx` 的主 `useEffect` 钩子（该钩子在 `isOpen` 变为 `true` 时执行）的顶部，强制添加了 `setIsSmartFilling(false);`。这确保了无论上一次的状态如何，每当模态框被打开时，AI 分析状态都会被可靠地重置为初始的 `false` 状态，从而解决了卡死问题。

### ✅ 已修复: 表格视图 (Table View) 未显示子任务进度

*   **故障现象 (Symptom)**: 
    在“列表视图”中，“子任务”一列始终是空白的，即使用户的任务包含子任务。

*   **根本原因 (Root Cause)**:
    该列的渲染逻辑在之前的虚拟化重构中被标记为 `... (not implemented in original) ...`，没有被实现。

*   **解决方案 (Resolution)**:
    在 `TableView.tsx` 中实现了“子任务”列的渲染逻辑。现在，如果一个任务包含子任务，该列会显示一个图标以及 `完成数/总数` 的进度文本（例如 `2/5`），与应用中其他视图的子任务显示方式保持一致。

### ✅ 已修复: 表格视图列标题显示不全

*   **故障现象 (Symptom)**: 
    在“列表视图”中，部分列（如“状态”、“优先级”、“子任务”）的默认宽度过窄，导致它们的中文标题被截断。

*   **根本原因 (Root Cause)**:
    `TableView.tsx` 中 `colWidths` 状态的初始值对于某些包含中文标题的列来说过于保守。

*   **解决方案 (Resolution)**:
    调整了 `colWidths` 的默认值，将 `status` 从 60 增加到 80，`priority` 从 90 增加到 100，`subtasks` 从 80 增加到 100。这些调整为列标题提供了足够的空间，确保它们在初始加载时能够被完整显示，提升了界面的可读性。

---

## v2.8.2

*   **发布日期**: 2024-08-01 (示例日期)
*   **核心目标**: 修复导致应用崩溃的核心稳定性问题。

### ✅ 已修复: 编辑旧任务时，模态框崩溃并引发 "Script error"

*   **故障现象 (Symptom)**: 
    在某些情况下，点击“列表视图”按钮或尝试编辑一个旧任务时，应用会崩溃，并显示一个通用的 "Script error."。

*   **根本原因 (Root Cause)**:
    这是一个由数据兼容性问题引发的连锁错误。根本原因在于 `TaskDetailModal` 组件：当它尝试加载一个旧的、没有设置 `date` 字段的任务时，其内部状态（如 `startDate` 和 `recurStartDate`）会被设置为 `undefined`。这会导致 React 后续在处理日期相关的逻辑时（尤其是在 `RecurringOptions` 子组件中）因接收到无效的 `props` 而抛出运行时错误。这个渲染时的严重错误被错误地报告为了一个通用的 "Script error"，从而掩盖了真正的根源。

*   **解决方案 (Resolution)**:
    1.  **加固任务模态框**: 对 `TaskDetailModal.tsx` 的 `useEffect` 进行了关键修复。在从 `task` 对象初始化状态时，为 `task.date` 提供了回退值（`dateStr`），确保了 `startDate` 和 `recurStartDate` 状态永远不会被设置为 `undefined`，从而彻底解决了该崩溃问题。
    2.  **恢复看板视图稳定性**: 作为预防措施，将 `MatrixView.tsx` 中象限的显示顺序恢复为标准的 `Q1, Q2, Q3, Q4` 布局，以排除任何由最近的布局更改引入的潜在不稳定性。

---

## v2.8.1

*   **发布日期**: 2024-08-01 (示例日期)
*   **核心目标**: 修复导致应用部分功能不可用的严重 Bug。

### ✅ 已修复: 列表视图 (Table View) 崩溃导致白屏

*   **故障现象 (Symptom)**: 
    在应用主界面，当用户点击切换到“列表视图”时，整个视图区域变为空白，并在浏览器控制台显示一个通用的 "Script error."。

*   **根本原因 (Root Cause)**:
    该问题由两个因素共同导致：
    1.  **数据健壮性**: 筛选逻辑 `task.title.toLowerCase()` 未能处理数据库中可能存在的旧版、不规范的任务数据（即缺少 `title` 字段的任务）。当加载到这类数据时，在 `undefined` 上调用字符串方法会立即抛出运行时错误。
    2.  **过滤器持久化**: 当应用从 `localStorage` 加载之前保存的筛选条件时，如果“标题”筛选条件的值被意外地存为 `null`，也会导致同样的运行时错误。

*   **解决方案 (Resolution)**:
    对 `TableView` 组件进行了加固：
    1.  **修复数据处理**: 在筛选逻辑中增加了安全回退 `(task.title || '').toLowerCase()`，确保即使 `title` 字段缺失，代码也能稳定运行。
    2.  **增强过滤器加载**: 负责从 `localStorage` 加载筛选条件的 `getInitialFilters` 函数被重写，以确保解析出的每个筛选条件都经过验证和清洗，特别是保证 `title` 字段在任何情况下都是一个有效的字符串（回退到 `''`），从而彻底杜绝了该类型错误的发生。