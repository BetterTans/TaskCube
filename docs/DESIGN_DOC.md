# TaskCube - 软件设计与架构文档

**文档版本**: 1.1
**最后更新**: v3.1.1

---

## 1. 概述与核心原则 (Overview & Core Principles)

本文档旨在详细阐述 TaskCube 应用的架构设计、核心功能实现、数据模型以及未来的功能规划。它是项目开发的主要技术参考。

### 1.1. 项目愿景

TaskCube 旨在成为一款现代化、本地优先的智能待办事项与个人项目管理工具。它通过将优雅的、以键盘为中心的操作界面与灵活强大的 AI 助手相结合，帮助用户在保证数据绝对隐私的前提下，实现极致的工作效率。

### 1.2. 核心设计原则

*   **🔒 本地优先 (Local-First)**: 所有用户数据默认存储在设备本地的 IndexedDB 中。无云端，无需注册，不收集任何数据，确保用户的绝对隐私和离线可用性。
*   **🤖 AI 赋能 (AI-Powered)**: AI 不仅仅是辅助，更是工作流的核心部分。应用深度集成 AI，用于自然语言处理、任务规划与拆解，并提供可配置的、模型无关的 AI 引擎。
*   **⚡️ 效率至上 (Efficiency-First)**: 设计灵感源于专业开发者工具。全局指令面板 (Cmd+K)、可自定义热键和键盘优先的交互是核心，旨在最大限度地减少鼠标依赖，提升操作速度。
*   **✨ 直观可视化 (Intuitive Visualization)**: 通过四个强大的、相互关联的核心视图（日历、日、看板、表格），用户可以从不同维度理解和组织他们的工作。
*   **🚀 极致性能 (High-Performance)**: 应用在设计上充分考虑性能。通过列表虚拟化、精细化的渲染优化和高效的数据库查询，确保在处理海量任务时依然迅捷流畅。

---

## 2. 系统架构 (System Architecture)

### 2.1. 前端技术栈

*   **框架**: React 19
*   **语言**: TypeScript
*   **数据库**: Dexie.js (基于 IndexedDB)
*   **样式**: Tailwind CSS
*   **性能**: TanStack Virtual (用于列表虚拟化)
*   **图标**: Lucide React

### 2.2. 数据层 (Data Layer)

*   **数据库**: 选用 **Dexie.js** 作为 IndexedDB 的高级封装。
    *   **选型理由**:
        1.  **强类型支持**: 与 TypeScript 完美集成。
        2.  **简洁的 API**: 提供类似 ORM 的查询语法 (`db.tasks.where(...)`)，极大简化了 IndexedDB 的原生操作。
        3.  **版本管理**: 内置强大的数据库版本升级机制，便于未来扩展数据模型。
        4.  **React Hooks 集成**: 通过 `dexie-react-hooks` (`useLiveQuery`)，可以轻松实现组件与数据库查询的响应式绑定，当数据变更时自动触发组件重渲染。
*   **数据模型**: 定义在 `types.ts` 中，构成了应用的核心结构。

### 2.3. AI 服务层 (AI Service Layer)

*   **实现**: `services/aiService.ts`
*   **设计**: 采用**模型无关 (Model-Agnostic)** 的设计。
    *   **可配置端点**: 用户可以在设置中提供任何兼容 OpenAI API 格式的 `baseUrl`、`apiKey` 和 `model` 名称。这使得 TaskCube 可以无缝对接 OpenAI 官方、Google Gemini、自托管的本地模型（如 Llama）、或其他云服务商。
    *   **通用调用函数**: `callAI` 是所有 AI 请求的统一出口，它处理认证、请求构建和错误处理。通过 `expectJson` 参数，它可以智能地启用服务端的 JSON 模式，确保返回数据的结构化。

---

## 3. 数据模型 (Data Models)

*   **定义文件**: `types.ts`
*   **数据库结构**: `db.ts`

### 3.1. Task (核心任务模型)

```typescript
export interface Task {
  id: string;          // 主键
  title: string;
  description?: string;
  completed: boolean;
  priority: Priority;  // 'High', 'Medium', 'Low'
  quadrant?: EisenhowerQuadrant; // 'Q1', 'Q2', 'Q3', 'Q4'
  subTasks: SubTask[];
  createdAt: number;
  date: string;        // YYYY-MM-DD (开始日期)
  endDate?: string;     // YYYY-MM-DD (用于跨天任务)
  startTime?: string;   // HH:mm (若无则为全天任务)
  duration?: number;    // 分钟
  isExpanded: boolean; // UI 状态 (已废弃)
  recurringRuleId?: string;
  projectId?: string;
  tags?: string[];
  
  // v3.1 新增
  predecessorIds?: string[]; // 前置任务 ID 列表
  successorIds?: string[];   // 后置任务 ID 列表
}
```

### 3.2. Project (项目模型)

用于将一组相关的 `Task` 组织在一起，并跟踪总体进度。

### 3.3. RecurringRule (周期性规则模型)

这是一个“任务模板”，用于按预设规则（如每天、每周）自动生成未来的 `Task` 实例。

---

## 4. 功能规格 (Feature Specifications)

### 4.1. 多视图系统

#### 4.1.1. 日历视图 (`FullCalendar.tsx`)
*   **功能**: 以月为单位展示任务，支持跨天任务的可视化。
*   **核心技术**:
    *   **无限滚动**: 通过监听滚动事件，动态地在前后添加新的 `MonthBlock` 组件，实现流畅的无限月份导航。
    *   **事件布局算法**: `layoutWeekEvents` 函数是核心。它对每周的任务进行排序（长任务优先），并使用“车道 (lane)”算法将重叠的任务分配到不同的垂直轨道上，避免视觉重叠。
    *   **拖拽排程**: 利用 HTML5 的拖放 API，允许用户拖动任务到新的日期，并智能计算新的 `endDate`（如果存在）。

#### 4.1.2. 日视图 (`DayTimeView.tsx`)
*   **功能**: 以时间轴的形式精细化展示一天的日程。
*   **核心技术**:
    *   **无限滚动**: 与日历视图类似，动态加载前一天和后一天的 `DayBlock` 组件。
    *   **时间块布局**: 定时任务通过 CSS `absolute` 定位到其 `startTime` 对应的垂直位置，`height` 由 `duration` 决定。
    *   **拖拽与缩放**: 通过 `onMouseDown` 事件监听，动态计算鼠标位移，实现任务在时间轴上的拖拽（修改 `startTime`）和缩放（修改 `duration`）。

#### 4.1.3. 看板视图 (`MatrixView.tsx`)
*   **功能**: 基于艾森豪威尔矩阵（重要/紧急四象限）来组织和审视任务。
*   **核心技术**:
    *   **分类**: 任务根据其 `quadrant` 属性被分配到四个象限之一（默认为 Q2）。
    *   **拖拽重分类**: 允许用户在不同象限之间拖动任务卡片，拖放操作会直接更新任务的 `quadrant` 属性。
    *   **可折叠列**: 每个象限都可以独立折叠，以帮助用户聚焦于特定类型的任务。
    *   **统一的颜色系统**: 采用全局统一的颜色方案，通过颜色快速传达每个象限的行动指令：Q1 (红: 立即处理), Q2 (绿: 计划执行), Q3 (橙: 审慎处理), Q4 (蓝: 暂缓排除)。

#### 4.1.4. 表格视图 (`TableView.tsx`)
*   **功能**: 提供一个类似电子表格的、高信息密度的任务列表。
*   **核心技术**:
    *   **列表虚拟化**: 使用 `@tanstack/react-virtual`，无论有多少任务，DOM 中只渲染当前视口内可见的行，实现了极致的滚动性能。
    *   **可变列宽**: 通过监听表头的拖拽事件，允许用户自定义每一列的宽度。
    *   **多维度筛选**: 提供弹窗式筛选器，支持按状态、标题、项目、优先级等多个维度进行组合筛选。
    *   **行内编辑**: （未来规划）支持直接在单元格中快速修改任务属性。

### 4.2. 任务管理

#### 4.2.1. 任务创建与编辑 (`TaskDetailModal.tsx`)
*   **功能**: 这是所有任务的核心交互中枢，用于创建新任务、编辑现有任务、或编辑周期性规则模板。
*   **设计**: 采用 iOS 风格的全屏模态框，将不同属性（日期、项目、优先级、子任务等）分组到不同的区块中，结构清晰。
*   **交互细节**:
    *   **统一的颜色系统**: 四象限选择器采用与看板视图一致的全局颜色方案，确保视觉一致性。
    *   **优雅的浮窗**: 关联的“选择前置任务”等浮窗采用平滑的淡入放大动画和毛玻璃背景，提供更精致的、符合平台习惯的交互体验。

#### 4.2.2. 周期性任务 (`recurringService.ts`)
*   **功能**: 允许用户创建按天、周、月或自定义间隔重复的任务。
*   **核心技术**:
    *   **任务生成器**: `generateTasksFromRule` 是核心服务。它会在应用启动或规则变更时被调用，根据规则的 `startDate`、`frequency` 和 `interval`，向前计算并生成未来的任务实例，同时检查避免重复生成。

### 4.3. 项目管理

*   **功能**: 允许用户创建项目，将任务与之关联，并跟踪进度。
*   **组件**:
    *   `ProjectListModal.tsx`: 项目列表和创建入口。
    *   `ProjectDetailModal.tsx`: 项目详情页，包含任务列表、进度条和过程日志。

---

## 5. 计划中的功能 (Design-First)

本章节记录未来计划开发的功能的详细设计方案。

### 5.1. 任务依赖关系 (v3.1)

#### 5.1.1. 核心目标
*   引入“完成-开始 (Finish-to-Start)”的前后置依赖关系。
*   为复杂项目提供结构化的工作流。
*   在 UI 中清晰地标识出被阻塞的任务。

#### 5.1.2. 数据模型变更 (`types.ts`)
```typescript
export interface Task {
  // ... (现有字段)
  predecessorIds?: string[]; // 前置任务 ID 列表 (此任务依赖的任务)
  successorIds?: string[];   // 后置任务 ID 列表 (依赖此任务的任务)
}
```

#### 5.1.3. UI/UX 设计
*   **管理界面 (`TaskDetailModal`)**:
    *   新增“关联任务”区域，包含两个列表：
        1.  **前置任务**: 可通过搜索浮窗添加。已添加的任务以标签胶囊形式展示，可移除。
        2.  **后置任务**: 只读列表，自动显示所有依赖于当前任务的任务。
*   **可视化与约束**:
    *   **视觉标识**: 任何一个前置任务未完成，则该任务被视为“被阻塞”，并在所有视图中显示一个**锁定图标 (🔒)**。
    *   **核心约束**: 被阻塞的任务**不能被标记为完成**。其完成按钮（复选框、圆形按钮）将被禁用。

#### 5.1.4. 交互逻辑与约束
*   **防止循环依赖**: 在添加前置任务时，系统将进行递归检查，确保不会创建 A -> B -> A 这样的循环。如果检测到循环，将向用户显示错误提示。
*   **周期性任务**: 为简化实现，V1 版本中，依赖关系仅支持设置在单个任务实例上，不支持在周期性规则模板上设置。

---

## 6. 文档历史

*   **v1.1 (v3.1.1)**: 更新文档，记录了全局四象限颜色系统和浮窗动画改进。
*   **v1.0 (v2.10.1)**: 创建初始设计文档，追溯性记录现有功能，并添加“任务依赖关系”的初步设计。